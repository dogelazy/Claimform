<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Claim Form ‚Äì Income Statement & Cash Book</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    h2, h3 {
      color: #333;
    }
    .entry {
      margin-bottom: 15px;
      padding: 15px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    select, input {
      padding: 8px;
      margin: 5px 10px 5px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 180px;
    }
    .expense-fields, .unit-fields, .amount-wrapper {
      display: none;
      margin-top: 10px;
    }
    button {
      padding: 8px 12px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #entry-count {
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h2>Claim Form</h2>
  <h3>Generate Income Statement and Cash Book</h3>

  <p id="entry-count">Entries: 0</p>
  <div id="form-container"></div>

  <button onclick="addEntry()">‚ûï Add Entry</button>
  <button onclick="submitForm()">üì§ Submit</button><button onclick="window.location.href='tutorial.html'">üìò Tutorial</button>

        <footer class="site-footer">
        <p>&copy; YU52. All rights reserved.</p>
    </footer>
  <script>
    const revenueAccounts = ["Participation Fees", "Tutor Fees", "Donations", "Self Unit Funding", "Other Unit Funding"];
    const expenseAccounts = ["Event Materials", "Rent Expense", "Printing", "Stationery", "Carriage Inwards", "Prizes", "Promotion", "Refreshments", "Other Expenses"];

    function updateEntryCount() {
      document.getElementById('entry-count').textContent =
        `Entries: ${document.querySelectorAll('.entry').length}`;
    }

    function addEntry() {
      const container = document.getElementById('form-container');

      const div = document.createElement('div');
      div.className = 'entry';

      div.innerHTML = `
        <label>Type:</label>
        <select onchange="updateDropdown(this)">
          <option value="">Select Type</option>
          <option value="Revenue">Revenue</option>
          <option value="Expense">Expense</option>
        </select>

        <label>Account:</label>
        <select class="account-dropdown" disabled onchange="checkUnitField(this)">
          <option value="">Select Account</option>
        </select>

        <label>Date:</label>
        <input type="date" class="date" />

        <div class="amount-wrapper">
          <label>Amount:</label>
          <input type="number" placeholder="Amount" class="amount" min="0" step="0.01" />
        </div>

        <div class="unit-fields">
          <label>Unit Name:</label>
          <input type="text" placeholder="Enter Unit Name" class="unit-name" />
        </div>

        <div class="expense-fields">
          <label>Source of Purchase:</label>
          <input type="text" placeholder="Source (optional)" class="source" />

          <label>Original Price:</label>
          <input type="number" placeholder="Original Price" class="original" min="0" step="0.01" />

          <label>Discount:</label>
          <input type="number" placeholder="Discount" class="discount" min="0" step="0.01" />

          <label>Final Amount (read only):</label>
          <input type="number" class="final" readonly />
        </div>

        <button onclick="removeEntry(this)">‚ùå Remove</button>
      `;

      container.appendChild(div);
      updateEntryCount();

      const originalInput = div.querySelector('.original');
      const discountInput = div.querySelector('.discount');
      const finalInput = div.querySelector('.final');

      function updateFinal() {
        const original = parseFloat(originalInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        finalInput.value = Math.max(original - discount, 0).toFixed(2);
      }

      originalInput.addEventListener('input', updateFinal);
      discountInput.addEventListener('input', updateFinal);
    }

    function updateDropdown(typeSelect) {
      const entry = typeSelect.parentElement;
      const accountDropdown = entry.querySelector('.account-dropdown');
      const expenseFields = entry.querySelector('.expense-fields');
      const amountWrapper = entry.querySelector('.amount-wrapper');

      accountDropdown.innerHTML = '';
      let options = ['<option value="">Select Account</option>'];

      if (typeSelect.value === 'Revenue') {
        revenueAccounts.forEach(acc => options.push(`<option value="${acc}">${acc}</option>`));
        expenseFields.style.display = 'none';
        amountWrapper.style.display = 'block';
      } else if (typeSelect.value === 'Expense') {
        expenseAccounts.forEach(acc => options.push(`<option value="${acc}">${acc}</option>`));
        expenseFields.style.display = 'block';
        amountWrapper.style.display = 'none';
      }

      accountDropdown.innerHTML = options.join('');
      accountDropdown.disabled = false;
    }

    function checkUnitField(accountSelect) {
      const entry = accountSelect.parentElement;
      const unitFields = entry.querySelector('.unit-fields');
      if (accountSelect.value === "Other Unit Funding") {
        unitFields.style.display = 'block';
      } else {
        unitFields.style.display = 'none';
      }
    }

    function removeEntry(button) {
      button.parentElement.remove();
      updateEntryCount();
    }

    function submitForm() {
      const entries = document.querySelectorAll('.entry');
      const statements = [];

      entries.forEach(entry => {
        const type = entry.querySelector('select').value;
        const account = entry.querySelector('.account-dropdown').value;
        const date = entry.querySelector('.date')?.value || new Date().toISOString().split('T')[0];

        if (!type || !account) return;

        if (type === 'Revenue') {
          const amount = parseFloat(entry.querySelector('.amount').value);
          if (isNaN(amount)) {
            alert("Please enter a valid amount for revenue.");
            return;
          }

          const unitName = account === "Other Unit Funding"
            ? entry.querySelector('.unit-name').value || "Unnamed Unit"
            : null;

          const revenueEntry = {
            account_name: account,
            credit: amount,
            date: date
          };

          if (unitName) {
            revenueEntry.unit_name = unitName;
          }

          statements.push(revenueEntry);

        } else if (type === 'Expense') {
          const source = entry.querySelector('.source').value || "N/A";
          const original = parseFloat(entry.querySelector('.original').value) || 0;
          const discount = parseFloat(entry.querySelector('.discount').value) || 0;
          const final = parseFloat(entry.querySelector('.final').value);
          if (isNaN(final)) {
            alert("Please enter valid original price and discount for expense.");
            return;
          }
          statements.push({
            account_name: account,
            debit: final,
            source: source,
            original_price: original,
            discount: discount,
            final_amount: final,
            date: date
          });
        }
      });

      if (statements.length === 0) {
        alert("Please add at least one valid entry before submitting.");
        return;
      }

      fetch('http://localhost:5000/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ statements })
      })
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Income_Statement_and_Cash_Book.xlsx";
        a.click();
      });
    }

    addEntry(); // Add one entry by default
  </script>

</body>
</html>